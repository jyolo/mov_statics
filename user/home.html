
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>有影-个人中心</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="影视搜索">
  <meta name="description" content="影视搜索引擎">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@cf59e697c316826233c4b6bb3f5f9956109efa4e/static/layui/css/layui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@cf59e697c316826233c4b6bb3f5f9956109efa4e/static/css/global.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@cf59e697c316826233c4b6bb3f5f9956109efa4e/static/swiper/swiper.min.css">
  <style>
    .layui-colla-title{background-color: #FFFFFF;height: auto}
    .layui-colla-content{background-color: #FFFFFF;}
    .search-history .layui-btn{margin: 0.2rem;}
    .search-tag{display: inline-block;padding-bottom: 0.5rem;}
    .watchlog .layui-card-header{height: 24px;text-align: left;border-bottom: none}
    .watch_rate{width: 100%;display: block;}
    @media screen and (min-width: 960px){
      .watchlog .layui-card-body{height: 22rem;}
      .watchlog .layui-card-body img{width: 100%;height: 21rem;display: block;}

    }
    @media screen and (max-width: 768px){
      .watchlog .layui-card-body{height: 9rem;}
      .watchlog .layui-card-body img{width: 100%;height: 8.01rem;display: block;}
    }
  </style>
</head>

<body style="margin-top: 65px;">

<div class="fly-header layui-bg-black">
  <div class="layui-container">
    <a class="fly-logo go_back" href="javascript:;"  >
        <i class="layui-icon layui-icon-left" style="font-size: 20px;color: #009688;line-height: 41px"></i>
        <!--        <img src="static/images/logo.png" alt="layui">-->
    </a>

    <ul class="layui-nav fly-nav-user">
      <!-- 登入后的状态 -->
      <li class="layui-nav-item">
        <a class="fly-nav-avatar" href="javascript:;">
          <i class="layui-icon layui-icon-username" style="font-size: 25px; color: #009688;line-height: 61px" ></i>
        </a>
      </li>
    </ul>
  </div>
</div>
<div class="fly-home fly-panel " >
  <i class="layui-icon layui-icon-username" style="font-size: 25px; color: #009688;line-height: 61px"></i>
  <p style="padding: 10px 0; color: #5FB878;">用户：159*****653</p>
</div>

<div class="layui-container">

  <div class="layui-row">
    <div class="layui-card">
      <div class="layui-card-header" >
        <i class="layui-icon layui-icon-right watch-log-item" ></i>
        观看记录
        <span class="layui-layout-right more" lay-type="watchlog" style="margin-right: 20px;"><i class="layui-icon layui-icon-align-center"></i></span>
      </div>
      <div class="layui-card-body watch-log-content hidden">
        <div class="swiper-container watchlog">
          <div class="swiper-wrapper">

          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="layui-row">
    <div class="layui-card">
      <div class="layui-card-header" >
        <i class="layui-icon layui-icon-right" ></i>
        搜索记录
<!--        <span class="layui-layout-right more" lay-type="searchlog" style="margin-right: 20px;"><i class="layui-icon layui-icon-align-center"></i></span>-->
      </div>
      <div class="layui-card-body search-history-content hidden">
        <div  id="search-history-box">
          <script type="text/html" id="searchTpl">
            {{# if(d.length > 0){ }}
            {{#  layui.each(d, function(index, item){ }}
            <div class="search-tag"><button type="button" class="layui-btn layui-btn-sm layui-btn-radius ">{{ item }}</button></div>
            {{# }) }}
            {{# }else{ }}
            <div class="layui-flow-more">暂无数据</div>
            {{# } }}
          </script>
        </div>
      </div>
    </div>
  </div>


  <div class="layui-row" style="margin-top: 20px">
    <div class="layui-card">
      <div class="layui-card-header logout" >
        <i class="layui-icon layui-icon-right" ></i>
        退出
      </div>
    </div>
  </div>



</div>



<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@cf59e697c316826233c4b6bb3f5f9956109efa4e/static/mui/mui.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@cf59e697c316826233c4b6bb3f5f9956109efa4e/static/js/global.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@cf59e697c316826233c4b6bb3f5f9956109efa4e/static/layui/layui.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@cf59e697c316826233c4b6bb3f5f9956109efa4e/static/swiper/swiper.min.js"></script>
<script>
layui.config({
  version: "3.0.0"
  ,base: 'https://cdn.jsdelivr.net/gh/jyolo/mov_statics@cf59e697c316826233c4b6bb3f5f9956109efa4e/static/mods/'
}).extend({
  fly: 'index'
}).use(['element','custom','laytpl','jquery'],function(){
  var $ = layui.jquery
  var element = layui.element
  var laytpl = layui.laytpl
  var custom = layui.custom

  //获取搜索历史
  window.getSearchHistory = function(){
  	if(isLogin == false){
          $('.search-history-content').append('<div class="notic-login" style="text-align: center"><span  class="layui-btn" onclick="window.gotoLogin()">请登录</span></div>')
      }else{
          mui.ajax(conf.host + '/v1/getSearchHistory',{
              dataType:'json',//服务器返回json格式数据
              type:'get',//HTTP请求类型
              timeout:10000,//超时时间设置为10秒；
              headers:{'Authorization':localStorage.authToken},
              beforeSend:function(){
                $('.search-history-content').removeClass('hidden')
                $('.search-history-content').append(loading_dom)
              },
              success:function(msg){
                  $('.search-history-content').find('.layui-flow-more').remove()
                  laytpl(searchTpl.innerHTML).render(msg.data, function(html){
                      document.getElementById('search-history-box').innerHTML = html
                  });


              },
              error:function(xhr,type,errorThrown){
                  custom.ajaxErrorHandler(xhr)
              }
          });
      }

  }
  window.addEventListener('getSearchHistory',getSearchHistory)

  // 获取播放记录
  window.getWatchLoggerList = function(){
      if(isLogin == false){
          $('.watchlog').append('<div class="notic-login" style="text-align: center"><span  class="layui-btn " onclick="window.gotoLogin()">请登录</span></div>')
      }else{
          mui.ajax(conf.host + '/v1/getWatchLoggerList',{
              dataType:'json',//服务器返回json格式数据
              type:'post',//HTTP请求类型
              timeout:10000,//超时时间设置为10秒；
              headers:{'Authorization':localStorage.authToken},
              beforeSend:function(){
                $('.watch-log-content').addClass('layui-show')
                $('.watch-log-content').append(loading_dom)

              },
              success:function(msg){
                  if(msg.data.length > 0){
                      $('.watch-log-content').find('.layui-flow-more').remove()

                      let _list = []
                      $.each(msg.data,function(k,v){

                          var watch_log_info = {
                              'play_detail_id' : v.play_detail_id,
                              'play_line_index' : v.play_line_index ? v.play_line_index : 0,
                              'play_item_index' : v.play_item_index ? v.play_item_index : 0 ,
                              'play_time' : v.play_time ? v.play_time : 0.00 ,
                              'video_total_time' : v.video_total_time ? v.video_total_time : 0.00 ,
                          }

                          let _dom = '<div class="layui-card watch_log_item">' +
                              '<div class="layui-card-header">'+v.title+'</div>'+
                              '<div class="layui-card-body">'+
                              '<a href="javascript:;" data-index="'+k+'" data="'+v.play_detail_id+'" ><img class="lazy" src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics/static/images/default.png" data-echo="'+conf.cover_host + v.cover+'" /></a>'+
                              '<span class="watch_rate">'+
                              '<div class="layui-progress" lay-showPercent="true">'+
                              '<div class="layui-progress-bar layui-bg-red" lay-percent="'+v.watch_rate+'"></div>'+
                              '</div>' +
                              '</span>'+
                              '</div>'+
                              '</div>'

                          _list.push(_dom)
                      })
                      window.swiper_watchlog = new Swiper('.watchlog', {
                          slidesPerView: 3,
                          slidesPerGroup:3,
                          centeredSlides: false,
                          spaceBetween: 1,
                          virtual: {
                              slides: [],
                          },
                          on:{
                              slideChange: function(){
                                  bind_tap_on_history_item()
                                  element.init()
                                  window.Echo.init()
                              },
                          },
                      });
                      window.swiper_watchlog.virtual.removeAllSlides()
                      window.swiper_watchlog.virtual.appendSlide(_list)
                      window.swiper_watchlog.virtual.update()

                      //初始化 进度条 绑定 点击事件
                      window.bind_tap_on_history_item = function(){
                          mui('.swiper-slide').on('tap','a',function(){
                              detail_id = this.getAttribute('data')

                              setWatchLogger(detail_id,function (msg) {
								  
								  detail_webview = plus.webview.getWebviewById('detail')
								  mui.fire(detail_webview,'checkLogin');
								  
                                  mui.openWindow({
                                      id:'detail' ,
                                      url:'../detail.html?id=' + detail_id
                                  });
                              })
                          })
                      }

                      bind_tap_on_history_item()
                      element.init()
                      window.Echo.init()
                  }else{
                      // $('.watchlog').fadeOut();
                      // $('.watchlog').next().fadeIn();
                      // $('.watchlog').parent().removeClass('layui-show')
                    $('.watch-log-content').append('<div class="layui-flow-more">暂无观看记录</div>')
                  }

              },
              error:function(xhr,type,errorThrown){
                  custom.ajaxErrorHandler(xhr)
              }
          });
      }
  }
  window.addEventListener('getWatchLoggerList',getWatchLoggerList)


  getWatchLoggerList()
  getSearchHistory()

  $('.more').on('tap',function(){
    switch ($(this).attr('lay-type')) {
      case 'watchlog':
        mui.openWindow({
          id:'watch_history' ,
          url:'../user/watch_history.html'
        });
        break;
      case 'searchlog':
        mui.openWindow({
          id:'auth' ,
          url:'user/home.html'
        });
        break;
    }
  })

  $('.logout').on('tap',function () {
    localStorage.removeItem('authToken');
    if(window.plus != undefined){
      alert('退出成功')
	  index_webview = plus.webview.getWebviewById('index')
	  HBuilder_webview = plus.webview.getWebviewById('HBuilder')
	  mui.fire(index_webview,'checkLogin');
	  mui.fire(HBuilder_webview,'checkLogin');
      mui.openWindow({
        id:'index' ,
        url:'../index.html'
      });
    }else{
      layer.alert('退出成功',function () {
        mui.openWindow({
          id:'index' ,
          url:'../index.html'
        });
      })
    }

  })



});
</script>

</body>
</html>