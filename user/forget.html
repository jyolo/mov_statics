<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>有影-登录/注册</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="影视搜索">
  <meta name="description" content="影视搜索引擎">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@f3a7fd33aec1021822e5a0d4c83cabcd112eb8bb/static/layui/css/layui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@f3a7fd33aec1021822e5a0d4c83cabcd112eb8bb/static/css/global.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@f3a7fd33aec1021822e5a0d4c83cabcd112eb8bb/static/swiper/swiper.min.css">
  <style type="text/css">
    .swiper-pagination{position: relative;}
  </style>
</head>
<body>

<div class="fly-header layui-bg-black">
  <div class="layui-container">
    <a class="fly-logo go_back" href="javascript:;">
      <!--      <img src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@f3a7fd33aec1021822e5a0d4c83cabcd112eb8bb/static/images/logo.png" alt="layui">-->
      <i class="layui-icon layui-icon-left" style="font-size: 20px;color: #009688;line-height: 41px"></i>
    </a>

  </div>
</div>

<div class="layui-container fly-marginTop">
  <div class="fly-panel fly-panel-user" pad20>
    <div class="layui-tab layui-tab-brief " lay-filter="user">
      <ul class="layui-tab-title swiper-pagination"></ul>
      <div class="layui-form layui-tab-content swiper-container" id="reglogin" style="padding: 20px 0;">
        <div class="swiper-wrapper">
          <!-- 找回密码 / 重置密码 -->
          <div class="layui-tab-item layui-show swiper-slide">
            <div class="layui-form layui-form-pane">
              <form method="post"  lay-filter="repassword">

                <div class="layui-form-item">
                  <label  class="layui-form-label">修改密码</label>
                  <div class="layui-input-inline">
                    <input type="password" lay-verify="required" lay-reqText="请输入要修改的密码" name="pwd" autocomplete="off" class="layui-input">
                  </div>
                </div>
                <div class="layui-form-item">
                  <label  class="layui-form-label">确认密码</label>
                  <div class="layui-input-inline">
                    <input type="password" lay-verify="required" lay-reqText="请再次输入要修改的密码" name="repwd"  autocomplete="off" class="layui-input">
                  </div>
                </div>
                <div class="layui-form-item">
                  <label  class="layui-form-label">手机号</label>
                  <div class="layui-input-inline">
                    <input type="text" lay-verify="required|phone" lay-reqText="请输入您注册的手机号" name="mobile"  autocomplete="off" class="layui-input">
                  </div>
                </div>
                <div class="layui-form-item">
                  <label  class="layui-form-label">短信验证码</label>
                  <div class="layui-input-inline">
                    <div class="layui-col-xs5 layui-col-sm5 layui-col-md5">
                      <input type="text" lay-verify="required|number" lay-reqText="请输入验证码" name="sms_verify_code"  autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-col-xs1 layui-col-sm1 layui-col-md1">&nbsp;</div>
                    <div class="layui-col-xs3 layui-col-sm3 layui-col-md3">
                      <button class="layui-btn" id="send_verify_code">发送验证码</button>
                    </div>
                  </div>
                </div>
                <div class="layui-form-item" style="text-align: center;">
                  <button class="layui-btn" lay-filter="repassword" lay-submit>确认修改</button>
                </div>
              </form>
            </div>

          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- <div class="fly-footer">
  <p><a href="http://fly.layui.com/" target="_blank">友影</a></p>
</div> -->

<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@f3a7fd33aec1021822e5a0d4c83cabcd112eb8bb/static/mui/mui.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@f3a7fd33aec1021822e5a0d4c83cabcd112eb8bb/static/js/global.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@f3a7fd33aec1021822e5a0d4c83cabcd112eb8bb/static/layui/layui.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@f3a7fd33aec1021822e5a0d4c83cabcd112eb8bb/static/swiper/swiper.min.js"></script>
<script>

  layui.config({
    version: "3.0.0"
    ,base: 'https://cdn.jsdelivr.net/gh/jyolo/mov_statics@f3a7fd33aec1021822e5a0d4c83cabcd112eb8bb/static/mods/'
  }).use(['custom','form','jquery','layer'],function(){
    var form = layui.form
    var $ = layui.jquery
    var custom = layui.custom
    var layer = layui.layer


    window.toggletab = function(indexNumber){
      window.swiper.slideTo(indexNumber)
    }
    window.swiper = new Swiper('#reglogin',{
      // 如果需要分页器
      pagination: {
        el: '.swiper-pagination',
        clickable:true,
        clickableClass : 'pagination-clickable',
        type: 'custom',
        renderCustom: function (swiper, current, total) {
          return '<li ><a onclick="javascript:toggletab(0)">找回密码 / 重置密码</a></li>'
        }
      },
    });
    $('#send_verify_code').click(function(){
      let _this = $(this)
      let mobile = $(this).parents('form').find('input[name="mobile"]').val().trim()
      // 防止重复点击触发事件
      if ($(this).hasClass('layui-btn-disabled')){return false}
      if(mobile.length == 0) {
        layer.msg('请输入手机号')
        return false
      }

      var timer
      mui.ajax(conf.host + '/v1/auth/sendVerifyCode',{
        data:{'account':mobile,'account_type':'mobile','action_type':'repassword'},
        dataType:'json',//服务器返回json格式数据
        type:'post',//HTTP请求类型
        timeout:10000,//超时时间设置为10秒；
        beforeSend:function(){loading = layer.load()},
        success:function(msg){
          if(msg.code == 0) {
            layer.msg(msg.msg)
            layer.close(loading);
            return false
          }else{
            layer.msg('短信发送成功，注意查收!')
            // 倒计时
            _this.addClass('layui-btn-disabled')
            let old_text = _this.html()
            let waittime = 60
            _this.html(waittime)
            timer = setInterval(function(){
              waittime = waittime-1
              if (waittime <= 0 ){
                _this.html(old_text)
                _this.removeClass('layui-btn-disabled')
                clearInterval(timer)
              }else{
                _this.html(waittime)
              }
            },1000)
            layer.msg('短信发送成功，注意查收!')
          }

          layer.close(loading);
        },
        error:function(xhr,type,errorThrown){
          //异常处理；
          clearInterval(timer)
        }
      });

      return false
    })

    form.on('submit(repassword)',function(data){
      if(isApp == false){
        data.field.client_type = 'h5'
        data.field.device_id = ''
      }else{
        data.field.client_type = 'android'
        data.field.device_id = plus.device.imei
      }

      let loading
      mui.ajax(conf.host + '/v1/auth/repassword',{
        data:data.field,
        dataType:'json',//服务器返回json格式数据
        type:'post',//HTTP请求类型
        timeout:20000,//超时时间设置为20秒；
        beforeSend:function(){loading = layer.load()},
        success:function(msg){
          console.log(msg.data)
          if(msg.code == 1){
            layer.alert('修改成功,前往登录',{closeBtn:0},function(){
              mui.openWindow({
                id:'home' ,
                url:'../user/auth.html'
              });
            })

          }else{
            layer.msg(msg.msg,{
              icon: 5,
              time:2000
            })
          }
          layer.close(loading);

        },
        error:function(xhr,type,errorThrown){
          //异常处理；
          console.log(type);
        }
      });

      return false
    })






  });
</script>

</body>
</html>