<!DOCTYPE html>
<html style="background-color: #e2e2e2;">
<head>
  <meta charset="utf-8">
  <title>友影</title>
  <meta name="keywords" content="影视搜索">
  <meta name="description" content="影视搜索引擎">
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="static/layui/css/layui.css">
  <link rel="stylesheet" href="static/css/global.css">
  <link rel="stylesheet" href="static/swiper/swiper.min.css">
  <link rel="stylesheet" href="static/player/video-js.min.css">
  <link rel="shortcut icon" href=" static/images/favicon.ico" />
  <script src="static/layui/layui.js"></script>
  <script src="static/swiper/swiper.min.js"></script>
  <script src="static/mui/mui.min.js"></script>
  <style>

  .fly-main{min-height: auto;}
  .layui-btn-normal{float: left;margin: 0.5rem;}
  .search{margin-top:3rem;}
  .search .keyword{height: 4rem ;border-radius: 2px}
  .search .submit{height: 4rem}
  .search-history .layui-btn{margin: 0.2rem;}
  .layui-colla-title{background-color: #FFFFFF;height: auto}
  .search-tag{display: inline-block;padding-bottom: 0.5rem;}
  .layui-card-header{height: 24px;text-align: left;border-bottom: none}
  .layui-card-body{height: 105px;}
  .watch_rate{width: 100%;display: block;}

  @media screen and (min-width: 960px){
	  .layui-card-body{height: 22rem;}
	  .layui-card-body img{width: 100%;height: 21rem;display: block;}
  }
  @media screen and (min-width: 768px){
	  .layui-card-body img{width: 100%;height: 7.01rem;display: block;}
  }


  .layui-card-body a{display: block;}
  .layui-progress-text{color: #EFEFF4;}
  .main-content{background: #FFFFFF;margin-top: 1rem;}
  .layui-tab-title li{min-width: 0px}
  #mov_category{z-index: 100000;background-color: white;}
  </style>
</head>
<body class="fly-full">

<div class="fly-header layui-bg-black">
  <div class="layui-container">
    <a class="fly-logo" href="/">
      <img src="static/images/logo.png" alt="layui">
    </a>

    
    <ul class="layui-nav fly-nav-user">
      <!-- 登入后的状态 -->
      <li class="layui-nav-item user_info">
        <a class="fly-nav-avatar" href="javascript:;">
          <img src="static/images/avatar/default.png">
        </a>
        <dl class="layui-nav-child">
          <dd><a href="user/set.html"><i class="layui-icon">&#xe620;</i>观看记录</a></dd>
          <dd><a href="user/message.html"><i class="iconfont icon-tongzhi" style="top: 4px;"></i>我的消息</a></dd>
          <dd><a href="user/home.html"><i class="layui-icon" style="margin-left: 2px; font-size: 22px;">&#xe68e;</i>我的主页</a></dd>
          <hr  class="layui-bg-black">
          <dd><a href="javascript:;" class="loginOut" style="text-align: center;">退出</a></dd>
        </dl>
      </li>
    
    </ul>
  </div>
</div>



<div class="fly-main" id="fly-main" style="overflow: hidden;">
    <!--logo-->
	<div class="layui-row" style="text-align: center">
		<div class="logo">
			<img src="https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png2" style="height: 200px;width:300px;border:1px solid black"/>
		</div>
	</div>
    <!--search box-->
	<div class="layui-row search" >
		 <form action="" class="layui-form search-form">
			 <div class="layui-col-xs8 layui-col-sm8 layui-col-md8">
				<input type="text" name="kw" required lay-verify="required" placeholder="开始搜搜吧" autocomplete="off" class="layui-input keyword">
			 </div>
			 <div class="layui-col-xs4 layui-col-sm4 layui-col-md4">
			 	<button  class="layui-btn layui-btn-fluid submit" lay-submit lay-filter="seachSubmit">搜索</button>
			 </div>
		 </form>
	</div>

    <!--search result-->
	<div class="layui-row main-content" id="main-content">
        <!--
	  <div class="layui-collapse" lay-accordion>

	    <div class="layui-colla-item search-item hidden" >
	      <h2 class="layui-colla-title ">搜索历史</h2>
	      <div class="layui-colla-content search-history-content" >
			  <div  id="search-history-box">
			    <script type="text/html" id="searchTpl">
			  			{{# if(d.length > 0){ }}
			  				{{#  layui.each(d, function(index, item){ }}
			  					<div class="search-tag"><button type="button" class="layui-btn layui-btn-sm layui-btn-radius ">{{ item }}</button></div>
			  				{{# }) }}
			  			{{# }else{ }}
			  				<div class="layui-flow-more">暂无数据</div>
			  			{{# } }}
			  		</script>
			  </div>
		  </div>
	    </div>

	    <div class="layui-colla-item watch-log-item hidden" >
			<h2 class="layui-colla-title">观看记录</h2>
			<div class="layui-colla-content watch-log-content">
			  <div class="swiper-container watchlog">
                    <div class="swiper-wrapper">

                    </div>
			  </div>

			</div>
	    </div>

		<div class="layui-colla-item search-result " >
			<h2 class="layui-colla-title" id="search_result">搜索结果 </h2>
			<div class="layui-colla-content ">
				<ul class="fly-case-list" id="vlistView" style="display: none;"></ul>
			</div>
		</div>

      </div>
        -->

        <script type="text/html" id="vlistScript">

            {{#  layui.each(d, function(index, item){ }}
            <li>
                <a href="#" class="vlist" data="{{ item.id }}">
                    <div class="layui-row ">
                        <div class="layui-col-xs4 layui-col-sm4 layui-col-md4 cover" >
                            <img class="lazy" src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics/static/images/default.png" data-echo="{{ conf.cover_host + item.cover_id }}" >
                        </div>
                        <div class="layui-col-xs8 layui-col-sm8 layui-col-md8 dinfo" >
                            <h5 class="title">{{ item.title }}</h5>
                            {{# if (item.year && item.year != ''){ }}
                            <p>年份: {{ item.year }}</p>
                            {{# }else{  }}
                            <p>年份: 未知</p>
                            {{# }  }}

                            {{# if (item.area && item.area != ''){ }}
                            <p>地区: {{ item.area }}</p>
                            {{# }else{  }}
                            <p>地区: 未知</p>
                            {{# }  }}

                            {{# if (item.director && item.director != ''){ }}
                            <p>导演: {{ item.director }}</p>
                            {{# }else{  }}
                            <p>导演: 未知</p>
                            {{# }  }}

                            {{# if (item.actor && item.actor != ''){ }}
                            <p>演员: {{ item.actor }}</p>
                            {{# }else{  }}
                            <p>演员: 未知</p>
                            {{# }  }}

                            {{# if (item.desc && item.desc != ''){ }}
                            <p>简介: {{ item.desc }}</p>
                            {{# }else{  }}
                            <p>简介: 未知</p>
                            {{# }  }}
                        </div>
                    </div>
                </a>
            </li>
            {{# }) }}

        </script>

      <div class="layui-row" >
          <div class="layui-tab layui-tab-brief" lay-filter="mov_category" id="mov_category">
              <ul class="layui-tab-title hidden" >
                  <li class="layui-this">电影</li>
                  <li>电视剧</li>
                  <li>综艺</li>
                  <li>动漫</li>
              </ul>
              <div class="layui-tab-content hidden">
                2222222222
              </div>
          </div>



      </div>

      <div class="layui-row">
          <div id="search_result_swpier" class="swiper-container hidden" >
              <div class="swiper-wrapper">
                  <div class="swiper-slide" id="dy"><ul class="fly-case-list"></ul></div>
                  <div class="swiper-slide" id="dsj"><ul class="fly-case-list"></ul></div>
                  <div class="swiper-slide" id="zy"><ul class="fly-case-list"></ul></div>
                  <div class="swiper-slide" id="dm"><ul class="fly-case-list"></ul></div>
              </div>
          </div>

      </div>


	</div>
	

</div>

<script src="static/mui/mui.min.js"></script>
<script src="static/js/global.js"></script>
<script src="static/layui/layui.js"></script>
<script src="static/swiper/swiper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-base64@2.6.3/base64.min.js"></script>
<script>
	layui.config({
	  version: "3.0.0"
	  ,base: 'static/mods/' //这里实际使用时，建议改成绝对路径
	}).extend({
	  fly: 'index'
	}).use(['element','form','layer','custom','util','laytpl'],function(){
		var backNum = 0
		mui.init({
			beforeback: function() {
				backNum++;
				if(backNum > 1) {
					plus.runtime.quit();
				} else {
					mui.toast("再按一次退出应用");
				}
				setTimeout(function() {
					backNum = 0
				}, 2000);
				return false;
				
			}
		})
		
		var $ = layui.jquery
		var form = layui.form
		var element = layui.element
		var laytpl = layui.laytpl
		var layer = layui.layer
		var custom = layui.custom
		var util = layui.util

        // 初始化 获取列表的cache
        layui.cache.getListDataFuncArgs = {}
        var list_tpl = vlistScript.innerHTML
        var list_requst_url = '/v1/search'
        var toend = false

        // 初始化选项卡的 swiper
        window.search_result_swpier = new Swiper('#search_result_swpier',{
            autoHeight: true,
            on: {
                slideChangeTransitionStart: function () {
                    $('.layui-tab-title').find('li').removeClass('layui-this');
                    $('.layui-tab-title').find('li').eq(this.activeIndex).addClass('layui-this');
                    layui.cache.current_data_type =  $('#search_result_swpier > .swiper-wrapper').find('.swiper-slide').eq(this.activeIndex).attr('id')
                    //首次切换过来没有数据的时候 加载一次数据
                    if(layui.cache.getListDataFuncArgs[layui.cache.current_data_type].page == 0 && $('#'+layui.cache.current_data_type).find('li').length == 0){
                        // 滚动到指定位置获取 数据
                        let $wrapper = $('.main-content');     // 父级容器
                        let $target = $('#search_result_swpier');    // 目标元素
                        window.scrollTo($target.offset().top - $wrapper.offset().top + $wrapper.scrollTop() ,0)
                        getListData()
                        this.update()

                    }else{

                        if(layui.cache.getListDataFuncArgs[layui.cache.current_data_type].scrollTop == undefined){
                            // window.scrollTo( 0,0)
                            $('html,body').animate({scrollTop: 0},100);
                        }else{
                            // console.log('===>' + layui.cache.getListDataFuncArgs[layui.cache.current_data_type].scrollTop)
                            $('html,body').animate({scrollTop: layui.cache.getListDataFuncArgs[layui.cache.current_data_type].scrollTop},150);

                        }
                        this.update()

                    }
                },
            }
        })

        //初始化 4个 选项卡的 cache
        $('#search_result_swpier').find('.swiper-slide').each(function (k,v) {
            console.log(v)
            layui.cache.getListDataFuncArgs[ $(v).attr('id') ] = {page:0}
            if(k == 0){
                layui.cache.current_data_type = $(v).attr('id')
            }
        })



        //监听 mov_category 点击
        element.on('tab(mov_category)', function(data){
            search_result_swpier.slideTo(data.index)
        })
	﻿
		// 进入播放页面之前 先记录播放记录 时间 等信息
		var setWatchLogger = function (detail_id ,successCallBack) {
            var headers = {}
		    if(isLogin == true){
                var headers = {'Authorization':localStorage.authToken}
            }
            mui.ajax(conf.host + '/v1/watchLogger',{
                data:{'id':detail_id},
                dataType:'json',//服务器返回json格式数据
                type:'post',//HTTP请求类型
                timeout:10000,//超时时间设置为10秒；
                headers:headers,
                success:function(msg){
                    if(msg.code == 1){
                        successCallBack(msg)
                    }else{
                        layer.msg(msg.msg)
                    }
                },
            });
		}

		//获取搜索历史
		var getSearchHistory = function(){
			if(isLogin == false){
                $('.search-history-content').append('<div class="notic-login" style="text-align: center"><span  class="layui-btn" onclick="window.gotoLogin()">请登录</span></div>')
            }else{
                mui.ajax(conf.host + '/v1/search/history',{
                    dataType:'json',//服务器返回json格式数据
                    type:'get',//HTTP请求类型
                    timeout:10000,//超时时间设置为10秒；
                    headers:{'Authorization':localStorage.authToken},
                    beforeSend:function(){
                        $('#search-history-box').find('.search-tag').remove()
                    },
                    success:function(msg){
                        laytpl(searchTpl.innerHTML).render(msg.data, function(html){
                            document.getElementById('search-history-box').innerHTML = html
                        });

                        // 搜索历史点击后直接触发 搜索
                        $('#search-history-box').find('button').on('click',function(){
                            $('.search-form').find('input[name=kw]').val('')
                            $('.search-form').find('input[name=kw]').val($(this).text())
                            $('.search-form').find('.submit').trigger('click')
                        })

                    },
                    error:function(xhr,type,errorThrown){
                        custom.ajaxErrorHandler(xhr)
                    }
                });
            }

		}
		window.addEventListener('getSearchHistory',getSearchHistory)

		// 获取播放记录
		var getWatchLoggerList = function(){
		    if(isLogin == false){
                $('.watchlog').append('<div class="notic-login" style="text-align: center"><span  class="layui-btn " onclick="window.gotoLogin()">请登录</span></div>')
            }else{
                mui.ajax(conf.host + '/v1/getWatchLoggerList',{
                    dataType:'json',//服务器返回json格式数据
                    type:'post',//HTTP请求类型
                    timeout:10000,//超时时间设置为10秒；
                    headers:{'Authorization':localStorage.authToken},
                    success:function(msg){
                        if(msg.data.length > 0){
                            $('.watch-log-content').addClass('layui-show')

                            let _list = []
                            $.each(msg.data,function(k,v){

                                var watch_log_info = {
                                    'play_detail_id' : v.play_detail_id,
                                    'play_line_index' : v.play_line_index ? v.play_line_index : 0,
                                    'play_item_index' : v.play_item_index ? v.play_item_index : 0 ,
                                    'play_time' : v.play_time ? v.play_time : 0.00 ,
                                    'video_total_time' : v.video_total_time ? v.video_total_time : 0.00 ,
                                }

                                let _dom = '<div class="layui-card watch_log_item">' +
                                    '<div class="layui-card-header">'+v.title+'</div>'+
                                    '<div class="layui-card-body">'+
                                    '<a href="javascript:;" data-index="'+k+'" data="'+v.play_detail_id+'" watch-log-info="'+Base64.encode(JSON.stringify(watch_log_info))+'"><img class="lazy" src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics/static/images/default.png" data-echo="'+conf.cover_host + v.cover+'" /></a>'+
                                    '<span class="watch_rate">'+
                                    '<div class="layui-progress" lay-showPercent="true">'+
                                    '<div class="layui-progress-bar layui-bg-red" lay-percent="'+v.watch_rate+'"></div>'+
                                    '</div>' +
                                    '</span>'+
                                    '</div>'+
                                    '</div>'

                                _list.push(_dom)
                            })
                            window.swiper_watchlog = new Swiper('.watchlog', {
                                slidesPerView: 3,
                                slidesPerGroup:3,
                                centeredSlides: false,
                                spaceBetween: 1,
                                virtual: {
                                    slides: [],
                                },
                                on:{
                                    slideChange: function(){
                                        bind_tap_on_history_item()
                                        element.init()
                                        window.Echo.init()
                                    },
                                },
                            });
                            window.swiper_watchlog.virtual.removeAllSlides()
                            window.swiper_watchlog.virtual.appendSlide(_list)
                            window.swiper_watchlog.virtual.update()

                            //初始化 进度条 绑定 点击事件
                            var bind_tap_on_history_item = function(){
                                mui('.swiper-slide').on('tap','a',function(){
                                    detail_id = this.getAttribute('data')
                                    data_index = this.getAttribute('data-index')
                                    // watch_log 三要素 play_line_index ,play_item_index,play_time 存入 localstarge
                                    let watch_log_info = this.getAttribute('watch-log-info')
                                    localStorage.setItem('watch_log_info',Base64.decode(watch_log_info))
                                    setWatchLogger(detail_id,function (msg) {

                                        mui.openWindow({
                                            id:'detail' ,
                                            url:'detail.html?id=' + detail_id
                                        });
                                    })
                                })
                            }

                            bind_tap_on_history_item()
                            element.init()
                            window.Echo.init()
                        }else{
                            $('.watchlog').fadeOut();
                            $('.watchlog').next().fadeIn();
                            $('.watchlog').parent().removeClass('layui-show')
                        }

                    },
                    error:function(xhr,type,errorThrown){
                        custom.ajaxErrorHandler(xhr)
                    }
                });
            }
		}
		window.addEventListener('getWatchLoggerList',getWatchLoggerList)


        getSearchHistory()
        getWatchLoggerList()

		//固定Bar
		util.fixbar({
		  // bar1: '&#xe68e;',
		  bgcolor: '#009688',
		  click: function(type){
			// if(type === 'bar1'){
			//   mui.openWindow({
			//       id:'index' ,
			//       url:'index.html'
			//     });
			// }
		  }
		});


		var getListData = function(){

			let loading_dom = '<div class="layui-flow-more"><a href="javascript:;"><i class="layui-anim layui-anim-rotate layui-anim-loop layui-icon ">&#xe63d;</i></a></div>'

            let params = layui.cache.form_data
            params.page = layui.cache.getListDataFuncArgs[layui.cache.current_data_type].page
            params.data_type = layui.cache.current_data_type

            // console.log(params)
            var heards = {}
			if(isLogin){
			    var heards = {'Authorization':localStorage.authToken}
            }
			mui.ajax(conf.host + list_requst_url,{
				data:params,
				dataType:'json',//服务器返回json格式数据
				type:'get',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				headers:heards,
				beforeSend:function(){

				    if($('#' + layui.cache.current_data_type).find('.layui-flow-more').length == 0){
                        $('#' + layui.cache.current_data_type).append(loading_dom)
                        search_result_swpier.update()

                    }

				},
				success:function(msg){
                    $('.logo').slideUp()

					if(msg.data.list.length > 0){
						layui.laytpl(list_tpl).render(msg.data.list, function(html){
                            $('#' + layui.cache.current_data_type).find('.layui-flow-more').remove()
                            $('#' + layui.cache.current_data_type).find('ul').append(html)
                            search_result_swpier.update()

                            // if(lock_scroll == false){
                            //     toend = true
                            // }

							toend = true

						});
						
						
						window.sticky.refresh()
						window.sticky.update({
							top:51
						})
						
					}else{
						toend = false
                        $('#' + layui.cache.current_data_type).find('.layui-flow-more').remove()
                        $('#' + layui.cache.current_data_type).append('<div class="layui-flow-more">没有更多了</div>')
                        search_result_swpier.update()
					}

					window.Echo.init()


					
					


                },
				error:function(xhr,type,errorThrown){
					console.log(xhr)
				}
			});
		}
		
		$(window).scroll(
			function () {
				var scrollTop = $(this).scrollTop();
				var scrollHeight = $('#'+ layui.cache.current_data_type).height();
				var windowHeight = $(this).height();
                var current_data_type = layui.cache.current_data_type
                // 记录每个选项卡的滚动位置
                layui.cache.getListDataFuncArgs[current_data_type].scrollTop = scrollTop
                // 距离底部 还有100 px  （滚动高度 + 窗口高度 + 100 > 窗口高度）
				if (scrollTop + windowHeight + 100 >= scrollHeight && toend == true) {
                    toend=false;
					// 分页 + 1
					layui.cache.getListDataFuncArgs[current_data_type].page = layui.cache.getListDataFuncArgs[current_data_type].page + 1
					getListData()
				}
			}
		);


		form.on('submit(seachSubmit)', function(data){

			let view = $('#vlistView').empty()
			//显示 搜索结果折叠面板
			if($('#search_result').next().hasClass('layui-show') == false){
				$('#search_result').parent('.layui-colla-item').fadeIn()
				$('#search_result').trigger('click')
				$('#vlistView').fadeIn()
			}

			$('#search_result_swpier').removeClass('hidden')
            search_result_swpier.init()

			$('.layui-tab-title').removeClass('hidden')

            layui.cache.form_data = data.field
            //清楚4个选项卡里面的所有li
            $('.fly-case-list').find('li').remove()

            getListData()


			window.sticky = new hcSticky('#mov_category', {
                stickTo: '#main-content',
                top:51
            });
			
			mui('#vlistView').on('tap','.vlist',function(){
				detail_id = this.getAttribute('data')
				// localStorage.removeItem('watch_log_info')
				setWatchLogger(detail_id ,function(msg){
					mui.openWindow({
						id:'detail' ,
						url:'detail.html?id=' + detail_id
					});
				})

			})
		  
		    return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
		});

		// app 中
		mui.plusReady(function () {

			wv = plus.webview.currentWebview()
			wv.addEventListener('popGesture',function(e){
				console.log('popGesture: '+e.type+','+e.result+','+e.progress)
			})
			console.log("当前页面URL："+plus.webview.currentWebview().getURL());
			console.log(JSON.stringify(plus.webview.currentWebview()));
		})

		
	});
	

	
	
	
	
</script>
</body>
</html>