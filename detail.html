<!DOCTYPE html>
<html style="background-color: #e2e2e2;">
<head>
  <meta charset="utf-8">
  <meta name="keywords" content="{{ lay.base.keywords }}">
  <meta name="description" content="{{ lay.base.description }}">
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Layui</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@e9414ea8b45f45628a7cef7064210010383ba4db/static/layui/css/layui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@e9414ea8b45f45628a7cef7064210010383ba4db/static/css/global.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@e9414ea8b45f45628a7cef7064210010383ba4db/static/swiper/swiper.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@e9414ea8b45f45628a7cef7064210010383ba4db/static/player/video-js.min.css">

  <style>

  @media screen and (min-width: 960px){
      #playbox{width: 100%;height: 33rem;}

  }
  @media screen and (max-width: 768px){
      #playbox{width: 100%;height: 15rem;}

  }
  .pre_nex{position: relative;top: 29px;}
  /* .fly-column{padding: 0px;} */
  .fly-panel{background: none;}
  .fly-column{margin-top: 1rem;}
  .fly-main{min-height: auto;}
  .layui-btn-normal{float: left;margin: 0.5rem;}
  #playwrapper botton{float: left}
  .swiper-button-next:after, .swiper-button-prev:after{font-size: unset}
  .swiper-button-next, .swiper-button-prev{color: #009688;}
      .hidden{display: none}
  </style>
</head>
<body class="fly-full">

<div class="fly-header layui-bg-black">
  <div class="layui-container">
    <a class="fly-logo go_back" href="javascript:;"  onclick="go_back()">
        <i class="layui-icon layui-icon-left" style="font-size: 20px;color: #009688;line-height: 41px"></i>
        <!--        <img src="static/images/logo.png" alt="layui">-->
    </a>


      <ul class="layui-nav fly-nav-user" >
          <script type="text/html" id="user_login_status">

              {{#  if(d.islogin === true){ }}
              <li class="layui-nav-item" >
                  <a class="fly-nav-avatar" href="javascript:;" lay-type="home">
                      <i class="layui-icon layui-icon-username" style="font-size: 25px; color: #009688;line-height: 61px" ></i>
                  </a>
              </li>
              {{# }else{ }}
              <li class="layui-nav-item user_info">
                  <a class="fly-nav-avatar" href="javascript:;" lay-type="auth" style="color: #009688">
                      登录/注册
                  </a>
              </li>
              {{# } }}
          </script>
      </ul>

  </div>
</div>

<div class="fly-panel fly-column">
  <div class="layui-container" >
    <div class="layui-row" style="text-align: center">
        <h4 id="mov_title"></h4>
    </div>
	<div class="layui-row" >
		<div class="layui-col-xs12 layui-col-sm12 layui-col-md12" id="playbox"></div>
	</div>
    
  </div>
</div>

<div class="fly-main" style="overflow: hidden;">

	<div class="layui-row" >
		<!-- <blockquote class="layui-elem-quote  swiper-pagination" style="position: unset;">引用区域的文字</blockquote> -->

        <div class="pre_nex" style="display: none">
            <div class="swiper-button-prev"></div>
            <div class="swiper-button-next"></div>
        </div>
        <div class="swiper-pagination" style="position: unset;padding: 1rem;"></div>
		<hr>
		<div class="swiper-container play-line">

            <div class="swiper-wrapper" id="playwrapper">
				<div class="layui-flow-more" style="width: 100%"><a href="javascript:;"><i class="layui-anim layui-anim-rotate layui-anim-loop layui-icon ">&#xe63d;</i></a></div>
				<script type="text/html" id="playitem">
					{{#  layui.each(d, function(index, item){ }}
						<div class="swiper-slide">
							{{#  layui.each(item.play_m3u8 , function(k, v){ }}
								<button type="button" class="layui-btn layui-btn-radius layui-btn-normal play-botton" data="{{ v.value }}">{{ v.name }}</button>
							{{# }) }}
						</div>
					{{# }) }}
				</script>
            </div>

		</div>
		
	</div>
  

</div>

<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@e9414ea8b45f45628a7cef7064210010383ba4db/static/mui/mui.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@e9414ea8b45f45628a7cef7064210010383ba4db/static/js/global.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@e9414ea8b45f45628a7cef7064210010383ba4db/static/layui/layui.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@e9414ea8b45f45628a7cef7064210010383ba4db/static/swiper/swiper.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@e9414ea8b45f45628a7cef7064210010383ba4db/static/player/hls.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jyolo/mov_statics@e9414ea8b45f45628a7cef7064210010383ba4db/static/player/DPlayer.min.js"></script>
<script>

	window.dp = new DPlayer({
	    container: document.getElementById('playbox'),
	    autoplay: true,
		airplay:true,
		video: {
			pic: 'http://images.shejidaren.com/wp-content/uploads/2018/03/134715wPw.jpg',
			type: 'customHls',
			customType: {
				customHls: function (video, player) {
					window.hls = new Hls({
						xhrSetup: (xhr, url) => {
							//播放m3u8 url转换成 https  且 不对当页面发起请求
							if(url.indexOf('mov_statics/detail.html?id=') == -1) {
								xhr.open('GET', url.replace('http://', 'https://'))
							}
						}
					});
					hls.loadSource(video.src);
					hls.attachMedia(video);
				},
			},
		},
	    theme: '#FADFA3',
	    loop: false,
	    lang: 'zh-cn',
	    preload: 'auto',
		
	});


	
	layui.config({
	  version: "3.0.0"
	  ,base: 'https://cdn.jsdelivr.net/gh/jyolo/mov_statics@e9414ea8b45f45628a7cef7064210010383ba4db/static/mods/' //这里实际使用时，建议改成绝对路径
	}).extend({
	  fly: 'index'
	}).use(['element','laytpl','custom','layer','jquery','util'],function(){
		mui.init()
		var $ = layui.jquery
		var laytpl = layui.laytpl
		var custom = layui.custom
		var layer = layui.layer
		var util = layui.util
		
		var isopen_ws = false
		
		//固定Bar
		// util.fixbar({
		//   bar1: '&#xe603;'
		//   ,bgcolor: '#009688'
		//   ,click: function(type){
		// 	if(type === 'bar1'){
		// 	  mui.back()
		// 	}
		//   }
		// });

        // 修改播放器样式
        $('.dplayer-bar').css('height','7px')
        $('.dplayer-loaded').css('height','7px')
        $('.dplayer-played').css('height','7px')
        $('.dplayer-thumb').css('margin-top','-2px')



		window.render_login_status = function(){
			laytpl(user_login_status.innerHTML).render({'islogin': (localStorage.authToken != undefined) }, function(html){
				$('.fly-nav-user').find('li').remove()
			    $('.fly-nav-user').append(html)
				
			    $('.fly-nav-user').find('a').on('tap',function(){
			        switch ($(this).attr('lay-type')) {
			            case 'auth':
							if((localStorage.authToken != undefined) == false){

								mui.openWindow({
								    id:'auth' ,
								    url:'user/auth.html'
								});
							}else{
								home_webview = plus.webview.getWebviewById('home')
								mui.fire(home_webview,'checkLogin');
								dp.pause()
								mui.openWindow({
								    id:'home' ,
								    url:'user/home.html'
								});
							}
			                
			                break
			            case 'home':
			                if(window.plus != undefined){
                                home_webview = plus.webview.getWebviewById('home')
                                mui.fire(home_webview,'checkLogin');
                                mui.fire(home_webview,'getWatchLoggerList');
                                mui.fire(home_webview,'getSearchHistory');
                            }
							
							dp.pause()

			                mui.openWindow({
			                    id:'home' ,
			                    url:'user/home.html'
			                });
			                break;
			
			        }
			    })
			
			});
			
		}
		render_login_status()
        if (custom.params == false){
            layer.open({
                title: '友情提醒',
                btn:[],
                closeBtn:0,
                content: '参数缺失！'
            });
            return false
        }
        var headers = {};
        if(isLogin == true){
            var headers = {'Authorization':localStorage.authToken}
        }


        mui.ajax(conf.host + '/v1/getWatchLoggerDetail', {
            data: {detail_id: custom.params.id},
            dataType: 'json',//服务器返回json格式数据
            type: 'get',//HTTP请求类型
            timeout: 10000,//超时时间设置为10秒；
            headers: headers,
            success: function (msg) {

                if(msg.code == 1){
                    watch_log_info = msg.data
                    layui.cache.play_info = {
                        'play_detail_id':watch_log_info.play_detail_id,
                        'play_line_index': watch_log_info.play_line_index,
                        'play_item_index' : watch_log_info.play_item_index ,
                        'play_time':watch_log_info.play_time,
                        'video_total_time' : watch_log_info.video_total_time,
                    }

                }else{
                    watch_log_info = undefined
                    layui.cache.play_info = {
                        'play_detail_id':custom.params.id,
                        'play_line_index': 0,
                        'play_item_index' : 0 ,
                        'play_time':0,
                        'video_total_time' : 0,
                    }
                }

                getDetail()
                
            }
        })


        window.getDetail = function () {


            mui.ajax(conf.host + '/v1/getDetail',{
                data:{id:custom.params.id},
                dataType:'json',//服务器返回json格式数据
                type:'get',//HTTP请求类型
                timeout:10000,//超时时间设置为10秒；
                headers:headers,
                success:function(msg){
					if(msg.code == 0){
						layer.alert('暂无数据',{closeBtn:0}, function(index){
						  //do something
						  mui.back()
						  layer.close(index);
						});       
						return false
					}
                    if(msg.data.length > 0){
                        $('#mov_title').append(msg.data[0]['title'])
                    }
                    let getTpl = playitem.innerHTML
                    let view = document.getElementById('playwrapper');
                    layui.laytpl(getTpl).render(msg.data, function(html){
                        view.innerHTML = html;
                    });
                    //遍历线路
                    window.swiper_play_line = new Swiper('.play-line', {
                        slidesPerView: 1,
                        slidesPerGroup:1,
                        centeredSlides: true,
                        spaceBetween: 5,
                        pagination: {
                            el: '.swiper-pagination',
                            type: 'custom',
                            renderCustom: function (swiper, current, total) {
                                return '当前线路：' + current + ' ；共 ' + total + '条线路';
                            }
                        },
                        navigation: {
                            nextEl: '.swiper-button-next',
                            prevEl: '.swiper-button-prev',
                        },
                    });
                    $('#playwrapper').find('.layui-flow-more').fadeOut()
                    $('.pre_nex').fadeIn()


                    // 有播放记录
                    if(watch_log_info != undefined && watch_log_info.play_time > 0){
                        layer.msg('开始继续播放')
                        // 预加载播放记录中的线路 和 item
                        dp.switchVideo({
                            url: msg.data[watch_log_info.play_line_index]['play_m3u8'][watch_log_info.play_item_index]['value'],
                            type: 'customHls',
                            pic: 'http://images.shejidaren.com/wp-content/uploads/2018/03/134715wPw.jpg',

                        })
                        dp.seek(watch_log_info.play_time); //跳转到指定时间位置

                        pli = watch_log_info.play_line_index
                        pii = watch_log_info.play_item_index
                    }else{
                        // 预加载第一个
                        window.dp.switchVideo({
                            url: msg.data[0]['play_m3u8'][0]['value'],
                            type: 'customHls',
                            pic: 'http://images.shejidaren.com/wp-content/uploads/2018/03/134715wPw.jpg',

                        })

                        pli = layui.cache.play_info.play_line_index = 0
                        pii = layui.cache.play_info.play_item_index = 0

                    }

                    // hls error info https://github.com/video-dev/hls.js/blob/master/docs/API.md#Errors
                    hls.on(Hls.Events.ERROR,function(event,data){

                        if(data.type == 'mediaError' && data.details == 'bufferStalledError'){
                            dp.notice('视频缓冲中.....')
                            return
                        }
                        if(data.type == 'networkError' && data.details == 'manifestLoadError'){
                            custom.hlsNetWrokerErrorHandler(msg)
                        }
                    })

                    window.swiper_play_line.slideTo(pli)
                    $(window.swiper_play_line.slides[pli]).find('.play-botton').eq(pii).addClass('layui-btn-disabled')

                    //切换线路播放 只更新 play_line_index 和 play_item_index
                    mui('#playwrapper').on('tap','.play-botton',function(){
                        if($(this).hasClass('layui-btn-disabled')) {
                            return
                        }else{
                            $('#playwrapper').find('.play-botton').removeClass('layui-btn-disabled')
                            $(this).addClass('layui-btn-disabled')
                        }


                        playurl = this.getAttribute('data')

                        layui.cache.play_info['play_detail_id'] = custom.params.id
                        layui.cache.play_info['play_line_index'] = window.swiper_play_line.activeIndex

                        dp.switchVideo({
                            url: playurl,
                            type: 'customHls',
                            pic: 'http://images.shejidaren.com/wp-content/uploads/2018/03/134715wPw.jpg',
                        })


                        hls.on(Hls.Events.ERROR,function(event,data){
                            console.log()
                            if(data.type == 'mediaError' && data.details == 'bufferStalledError'){
                                dp.notice('视频缓冲中.....')
                                return
                            }
                            if(data.type == 'networkError' && data.details == 'manifestLoadError'){
                                custom.hlsNetWrokerErrorHandler(msg)
                            }
                        })

                        // 如果之前有在其它线路 "同一个索引的 play_botton" 播放过，切换线路的时候 依然按照之前的 播放进度 播放
                        if(layui.cache.play_info['play_time'] > 0 && layui.cache.play_info['play_item_index'] == $(this).index()){
                            dp.seek(layui.cache.play_info.play_time)

                        }else{
                            layui.cache.play_info['play_item_index'] = $(this).index()
                        }

                        console.log(layui.cache.play_info)

                    })



                },
                error:function(xhr,type,errorThrown){
                    //异常处理；
                    custom.ajaxErrorHandler(xhr)
                },


            });
        }

		window.isplayed = false
		// 获取播放的时候 当前的时间
		dp.on('timeupdate', function () {

			// 更新cache 里面的 play_time
			layui.cache.play_info.play_time = dp.video.currentTime
            layui.cache.play_info.video_total_time = dp.video.duration

			// 定时间没有初始化 且 视频状态已就绪 则开始 定时器轮询  已登陆 才记录
			if (window.send_watch_info_interval == undefined && dp.video.readyState == 4 && isLogin == true){
				// ajax 轮询
				window.send_watch_info_interval = setInterval(function(){

                    mui.ajax(conf.host + '/v1/setWatchLog',{
                        data:layui.cache.play_info,
                        dataType:'json',//服务器返回json格式数据
                        type:'post',//HTTP请求类型,
                        timeout:10000,//超时时间设置为10秒；
                        headers:{'Authorization':localStorage.authToken},
                        success:function(msg){
                            // console.log(msg.msg)
                        },
                    });
				},2500)
				
			}


		});
		
		dp.on('play',function(){
			//播放开始的时候 获取当前的 线路
			layui.cache.play_info['play_line_index'] = window.swiper_play_line.activeIndex
			window.isplayed = true
			
		})
		
		dp.on('seeked',function(){
			console.log('seeked')
			dp.play()
		})
		
		// 加载视频第一帧 成功后触发 得到 获取第一帧的 总时间 /秒
		dp.on('loadedmetadata',function(a,b){
			console.log('loadedmetadata----------s')
            dp.play()
			console.log('loadedmetadata----------e')
		})
		
		dp.on('loadstart',function(a,b){
			console.log('loadstart----------s')
            dp.play()
			console.log('loadstart----------e')
		})
		
		dp.on('error',function(){
			console.log('error----------s')
			console.log('error----------e')
		})
		
		// 播放结束开始下一集
		dp.on('ended', function () {
			current_slide = window.swiper_play_line.slides[layui.cache.play_info.play_line_index]
			current_play_botton = $(current_slide).find('.play-botton').eq(layui.cache.play_info.play_item_index)
			
			// 当前播放线路有下一集
			if(current_play_botton.next().length >= 1){
				playurl = current_play_botton.next().attr('data')
				dp.switchVideo({
				    url: playurl,
					type: 'customHls',
				    pic: 'http://static.smartisanos.cn/pr/img/video/video_03_cc87ce5bdb.jpg',
				    thumbnails: 'https://moeplayer.b0.upaiyun.com/dplayer/hikarunara_thumbnails.jpg'
				})
				dp.play()
				
				$('#playwrapper').find('.play-botton').removeClass('layui-btn-disabled')
				current_play_botton.next().addClass('layui-btn-disabled')
				layer.msg('开始为您自动播放下一集',{'time':3000})
				
				// 更新播放记录
				layui.cache.play_info['play_line_index'] = window.swiper_play_line.activeIndex
				layui.cache.play_info['play_item_index'] = layui.cache.play_info.play_item_index + 1

                var headers = {}
                if(isLogin == true){
                    var headers = {'Authorization':localStorage.authToken}
                }
				mui.ajax(conf.host + '/v1/setWatchLog',{
				    data:layui.cache.play_info,
				    dataType:'json',//服务器返回json格式数据
				    type:'post',//HTTP请求类型,
				    timeout:10000,//超时时间设置为10秒；
				    headers:headers,
				    success:function(msg){
				        // console.log(msg.msg)
				    },
				});
				
			}else{
				layer.msg('播放结束',{'time':3000})
				// 清除定时器
				clearInterval(window.send_watch_info_interval)
			}
			
		});
		
		

		
	
		
	});
	
	
	
	
</script>
</body>
</html>